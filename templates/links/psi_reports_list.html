{% extends 'base.html' %}
{% load links_extras %}

{% block title %}PSI Reports - {{ link.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>PSI Reports for <span class="text-primary">{{ link.title }}</span></h1>
    <a href="{% url 'link_list' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Sites
    </a>
</div>

<div class="mb-3 d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
        <input type="date" id="startDate" class="form-control form-control-sm me-2" placeholder="Start date">
        <input type="date" id="endDate" class="form-control form-control-sm me-2" placeholder="End date">
        <input type="number" id="minScore" class="form-control form-control-sm me-2" placeholder="Min score" min="0" max="1" step="0.01">
        <input type="number" id="maxScore" class="form-control form-control-sm me-2" placeholder="Max score" min="0" max="1" step="0.01">
        <input type="text" id="reportSearch" class="form-control w-auto" placeholder="Search reports...">
    </div>
    <div>
        <button id="exportReportsBtn" class="btn btn-outline-success btn-sm ms-2"><i class="bi bi-download"></i> Export JSON</button>
        <button id="exportReportsCsvBtn" class="btn btn-outline-primary btn-sm ms-2"><i class="bi bi-file-earmark-spreadsheet"></i> Export CSV</button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover" id="reportsTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th colspan="4" class="text-center">Mobile Metrics</th>
                <th colspan="4" class="text-center">Desktop Metrics</th>
                <th>Actions</th>
            </tr>
            <tr>
                <th></th>
                <th></th>
                <th>FCP</th>
                <th>LCP</th>
                <th>CLS</th>
                <th>INP</th>
                <th>FCP</th>
                <th>LCP</th>
                <th>CLS</th>
                <th>INP</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for report in reports %}
            <tr>
                <td>{{ report.created_at|date:"Y-m-d" }}</td>
                <td>{{ report.created_at|date:"H:i:s" }}</td>
                {% with lhr=report.mobile_report.lighthouseResult %}
                    <td>{% with fcp=lhr.audits|getitem:'first-contentful-paint' %}{% if fcp.displayValue %}<span class="badge bg-info">{{ fcp.displayValue }}</span>{% else %}<span class="badge bg-secondary">N/A</span>{% endif %}{% endwith %}</td>
                    <td>{% with lcp=lhr.audits|getitem:'largest-contentful-paint' %}{% if lcp.displayValue %}<span class="badge bg-info">{{ lcp.displayValue }}</span>{% else %}<span class="badge bg-secondary">N/A</span>{% endif %}{% endwith %}</td>
                    <td>{% with cls=lhr.audits|getitem:'cumulative-layout-shift' %}{% if cls.displayValue %}<span class="badge bg-info">{{ cls.displayValue }}</span>{% else %}<span class="badge bg-secondary">N/A</span>{% endif %}{% endwith %}</td>
                    <td>{% with inp=lhr.audits|getitem:'interaction-to-next-paint' %}{% if inp.displayValue %}<span class="badge bg-info">{{ inp.displayValue }}</span>{% else %}<span class="badge bg-secondary">N/A</span>{% endif %}{% endwith %}</td>
                {% endwith %}
                {% with lhr=report.desktop_report.lighthouseResult %}
                    <td>{% with fcp=lhr.audits|getitem:'first-contentful-paint' %}{% if fcp.displayValue %}<span class="badge bg-info">{{ fcp.displayValue }}</span>{% else %}<span class="badge bg-secondary">N/A</span>{% endif %}{% endwith %}</td>
                    <td>{% with lcp=lhr.audits|getitem:'largest-contentful-paint' %}{% if lcp.displayValue %}<span class="badge bg-info">{{ lcp.displayValue }}</span>{% else %}<span class="badge bg-secondary">N/A</span>{% endif %}{% endwith %}</td>
                    <td>{% with cls=lhr.audits|getitem:'cumulative-layout-shift' %}{% if cls.displayValue %}<span class="badge bg-info">{{ cls.displayValue }}</span>{% else %}<span class="badge bg-secondary">N/A</span>{% endif %}{% endwith %}</td>
                    <td>{% with inp=lhr.audits|getitem:'interaction-to-next-paint' %}{% if inp.displayValue %}<span class="badge bg-info">{{ inp.displayValue }}</span>{% else %}<span class="badge bg-secondary">N/A</span>{% endif %}{% endwith %}</td>
                {% endwith %}
                <td>
                    <a href="{% url 'psi_report_detail' report.id %}" class="btn btn-outline-primary btn-sm" title="View Details">
                        <i class="bi bi-bar-chart"></i>
                    </a>
                    <button class="btn btn-outline-danger btn-sm delete-report-btn" data-report-id="{{ report.id }}" title="Delete Report">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="11" class="text-center">No reports found. Generate a report using the Fetch PSI button.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if page_obj.has_other_pages %}
<nav aria-label="Reports pagination">
  <ul class="pagination justify-content-center mt-3">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}
    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% else %}
        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
      {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// Search filter
const searchInput = document.getElementById('reportSearch');
searchInput.addEventListener('keyup', function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#reportsTable tbody tr');
    rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none';
    });
});

// Sorting (simple, by clicking headers)
document.querySelectorAll('#reportsTable th').forEach((th, idx) => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', function() {
        const table = th.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.querySelector('td'));
        const asc = th.classList.toggle('asc');
        rows.sort((a, b) => {
            let aText = a.children[idx].textContent.trim();
            let bText = b.children[idx].textContent.trim();
            if (!isNaN(parseFloat(aText)) && !isNaN(parseFloat(bText))) {
                aText = parseFloat(aText);
                bText = parseFloat(bText);
            }
            return asc ? (aText > bText ? 1 : -1) : (aText < bText ? 1 : -1);
        });
        rows.forEach(row => tbody.appendChild(row));
    });
});

// Delete report
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('reportsTable').addEventListener('click', function(e) {
        if (e.target.closest('.delete-report-btn')) {
            const btn = e.target.closest('.delete-report-btn');
            showConfirm('Are you sure you want to delete this report?', () => {
                const reportId = btn.getAttribute('data-report-id');
                showLoading();
                fetch(`/reports/${reportId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        btn.closest('tr').remove();
                        showToast('Report deleted.', 'success');
                    } else {
                        showToast(data.message || 'Failed to delete report.', 'danger');
                    }
                })
                .catch(() => showToast('Failed to delete report.', 'danger'))
                .finally(() => hideLoading());
            });
        }
    });
});

document.getElementById('exportReportsCsvBtn').addEventListener('click', function() {
    showLoading();
    window.location.href = window.location.pathname + 'export/csv/';
    setTimeout(hideLoading, 1000);
});

// Date range filter
const startDate = document.getElementById('startDate');
const endDate = document.getElementById('endDate');
const reportsTableRows = document.querySelectorAll('#reportsTable tbody tr');
function filterByDate() {
    const start = startDate.value ? new Date(startDate.value) : null;
    const end = endDate.value ? new Date(endDate.value) : null;
    reportsTableRows.forEach(row => {
        const dateText = row.children[0].textContent.trim();
        const rowDate = new Date(dateText);
        let show = true;
        if (start && rowDate < start) show = false;
        if (end && rowDate > end) show = false;
        row.style.display = show ? '' : 'none';
    });
}
startDate.addEventListener('change', filterByDate);
endDate.addEventListener('change', filterByDate);

const minScore = document.getElementById('minScore');
const maxScore = document.getElementById('maxScore');
function filterByScore() {
    const min = minScore.value ? parseFloat(minScore.value) : null;
    const max = maxScore.value ? parseFloat(maxScore.value) : null;
    reportsTableRows.forEach(row => {
        const scoreText = row.children[2].textContent.trim();
        const score = parseFloat(scoreText);
        let show = true;
        if (min !== null && (isNaN(score) || score < min)) show = false;
        if (max !== null && (isNaN(score) || score > max)) show = false;
        if (row.style.display !== 'none') row.style.display = show ? '' : 'none';
    });
}
minScore.addEventListener('input', filterByScore);
maxScore.addEventListener('input', filterByScore);
</script>
{% endblock %} 